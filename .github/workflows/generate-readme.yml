name: Generate new README.md

on: 
  push:
    branches: 
      - wip

jobs:
  generate: 
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v3

      - name: get information
        shell: bash
        run: |
          cp $PWD/.github/templates/README.md $PWD/
          for a in $(find . -maxdepth 1 -type d -not -path '*/\.*' \( ! -iname ".*" \)); do
             directory="$(basename $a)"
             echo -e "[${directory^}](https://github.com/${{github.repository}}/tree/master/$(basename $a))\\" >> README.md
             pushd $a
             rm README.md
             echo -e "| Script | Description |\n|--|--|" > README.md
             for b in $(find . -type f -iname "*.sh"); do
                filename="$(basename $b)"
                fileurl="https://github.com/${{github.repository}}/main/tree/$directory/$filename"
                filedescription="$(cat $b | grep '###~ description' | awk -F ': ' '{print $2}')"
                echo -e "| [$filename]($fileurl) | $filedescription |" >> README.md
             done
             popd
          done
       
      - name: Commit and push results
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git add -A 
            git commit -m "Update README.md"
            git push
          fi
